---
- hosts: localhost
  connection: local
  become: yes
  tasks:
  - name: Install docker
    ansible.builtin.apt:
      name: docker.io

  - name: Enable and start docker
    ansible.builtin.systemd_service:
      state: started
      enabled: true
      name: docker

  - name: Check if Kubernetes GPG key exists
    stat:
      path: "/etc/apt/keyrings/kubernetes.gpg"
    register: gpg_result

  - name: Curl and download Kubernetes GPG key
    ansible.builtin.shell: curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes.gpg
    when: not gpg_result.stat.exists

  - name: Add Kubernetes repository to list
    ansible.builtin.lineinfile:
      path: /etc/apt/sources.list
      line: "deb [arch=amd64 signed-by=/etc/apt/keyrings/kubernetes.gpg] http://apt.kubernetes.io/ kubernetes-xenial main"

  - name: Install Kubernetes
    ansible.builtin.apt:
      update_cache: true
      pkg:
      - kubeadm
      - kubelet
      - kubectl
